<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <title th:text="${productForm.id} != null ? '商品編集' : '新規商品登録'">商品登録</title>
    <style>
        /* ================================================
           全体リセット＆ベース設定
        ================================================ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        html, body {
            height: 100%;
        }
        body {
            font-family: 'Meiryo', 'Segoe UI', sans-serif;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background-color: #f5f5f5;
            color: #333;
        }

        /* ================================================
           ヘッダー（ロゴバー）
        ================================================ */
        .header {
            background-color: #ddd;
            padding: 12px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header .logo {
            font-size: 1.2em;
            font-weight: bold;
        }
        .header .logout {
            font-size: 0.95em;
        }
        .header .logout a {
            color: #333;
            text-decoration: none;
        }
        .header .logout a:hover {
            text-decoration: underline;
        }

        /* ================================================
           ナビゲーション（サイド/上部）
        ================================================ */
        .nav {
            background-color: #34495e;
            padding: 12px 24px;
        }
        .nav a {
            color: #ecf0f1;
            text-decoration: none;
            margin-right: 20px;
            font-size: 1em;
        }
        .nav a:hover {
            text-decoration: underline;
        }

        /* ================================================
           メインコンテンツ領域
        ================================================ */
        .container {
            flex: 1;
            width: 90%;
            max-width: 800px;
            margin: 24px auto;
            background-color: #fff;
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }

        .container h2 {
            margin-bottom: 20px;
            font-size: 1.5em;
            color: #2c3e50;
            text-align: center;
        }

        .form-group {
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
        }
        .form-group label {
            font-size: 1em;
            margin-bottom: 6px;
            color: #333;
        }
        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group textarea,
        .form-group select {
            padding: 8px 10px;
            font-size: 1em;
            border: 1px solid #bbb;
            border-radius: 4px;
            width: 100%;
        }
        .form-group textarea {
            resize: vertical;
            min-height: 120px;
        }
        .form-group .error-message {
            color: #d8000c;
            font-size: 0.9em;
            margin-top: 4px;
            padding-left: 4px;
        }

        /* 画像プレビュー */
        .img-preview {
            margin-top: 8px;
            max-width: 200px;
            max-height: 200px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        /* 送信ボタン */
        .submit-button {
            text-align: center;
            margin-top: 30px;
        }
        .submit-button button {
            padding: 10px 24px;
            font-size: 1em;
            background-color: #27ae60;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .submit-button button:hover {
            background-color: #1e874b;
        }

        /* 戻るリンク */
        .back-link {
            text-align: center;
            margin-top: 12px;
        }
        .back-link a {
            color: #555;
            text-decoration: none;
        }
        .back-link a:hover {
            text-decoration: underline;
        }

        /* ================================================
           フッター
        ================================================ */
        .footer {
            background-color: #888;
            text-align: center;
            padding: 12px 0;
            font-size: 0.85em;
            color: #eee;
        }
    </style>
    <script th:inline="javascript">
        /* 画像選択時にプレビューを表示する簡易スクリプト */
        function previewImage(event) {
            const fileInput = event.target;
            const preview = document.getElementById('imgPreview');
            if (fileInput.files && fileInput.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                }
                reader.readAsDataURL(fileInput.files[0]);
            } else {
                preview.src = '';
                preview.style.display = 'none';
            }
        }
    </script>
</head>
<body>
    <!-- ヘッダー -->
    <div class="header">
        <div class="logo">ロゴ</div>
        <div class="logout"><a th:href="@{/admin/logout-confirm}">ログアウト</a></div>
    </div>

    <!-- グローバルナビゲーション -->
    <div class="nav">
        <a th:href="@{/admin/dashboard}">ホーム</a>
        <a th:href="@{/admin/users}">ユーザー管理</a>
        <a th:href="@{/admin/products}">商品管理</a>
        <a th:href="@{/admin/orders}">注文管理</a>
        <a th:href="@{/admin/reports}">レポート</a>
    </div>

    <!-- メインコンテンツ -->
    <div class="container">
        <h2 th:text="${productForm.id} != null ? '商品編集' : '新規商品登録'">新規商品登録</h2>

        <!-- 共通エラー表示（存在する場合） -->
        <div th:if="${formError}" class="error-message" 
             th:text="${formError}">フォーム送信エラーが発生しました。</div>

        <!-- multipart/form-data を指定して画像アップロード対応 -->
        <form th:action="@{${productForm.id} != null ? '/admin/products/update' : '/admin/products/save'}"
              method="post"
              enctype="multipart/form-data"
              th:object="${productForm}">

            <!-- CSRF トークン -->
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

            <!-- 商品ID（編集時のみ隠しフィールドとして送信） -->
            <input type="hidden" th:if="${productForm.id != null}" th:field="*{id}" />

            <!-- 商品名 -->
            <div class="form-group">
                <label for="name">商品名<span style="color:#d8000c;">※</span></label>
                <input type="text" id="name" th:field="*{name}" placeholder="例：スマートフォン" />
                <div th:if="${#fields.hasErrors('name')}" th:errors="*{name}" class="error-message"></div>
            </div>

            <!-- カテゴリ選択 -->
            <div class="form-group">
                <label for="categoryId">カテゴリ<span style="color:#d8000c;">※</span></label>
                <select id="categoryId" th:field="*{categoryId}">
                    <option value="" th:text="${productForm.categoryId == null} ? '選択してください' : '選択してください'">選択してください</option>
                    <!-- カテゴリ一覧をコントローラから 'categories' モデルで渡す -->
                    <option th:each="cat : ${categories}"
                            th:value="${cat.id}"
                            th:text="${cat.name}"
                            th:selected="${cat.id == productForm.categoryId}">
                    </option>
                </select>
                <div th:if="${#fields.hasErrors('categoryId')}" th:errors="*{categoryId}" class="error-message"></div>
            </div>

            <!-- 価格 -->
            <div class="form-group">
                <label for="price">価格（円）<span style="color:#d8000c;">※</span></label>
                <input type="number" id="price" th:field="*{price}" placeholder="例：10000" min="0" step="1" />
                <div th:if="${#fields.hasErrors('price')}" th:errors="*{price}" class="error-message"></div>
            </div>

            <!-- 在庫数 -->
            <div class="form-group">
                <label for="stock">在庫数<span style="color:#d8000c;">※</span></label>
                <input type="number" id="stock" th:field="*{stock}" placeholder="例：50" min="0" step="1" />
                <div th:if="${#fields.hasErrors('stock')}" th:errors="*{stock}" class="error-message"></div>
            </div>

            <!-- 商品説明 -->
            <div class="form-group">
                <label for="description">商品説明</label>
                <textarea id="description" th:field="*{description}" placeholder="商品の詳細を入力してください"></textarea>
                <div th:if="${#fields.hasErrors('description')}" th:errors="*{description}" class="error-message"></div>
            </div>

            <!-- 画像アップロード -->
            <div class="form-group">
                <label for="imageFile">商品画像</label>
                <input type="file" id="imageFile" name="imageFile" accept="image/*" onchange="previewImage(event)" />
                <!-- 既存画像がある場合はプレビューを表示 -->
                <img th:if="${productForm.imageUrl != null}"
                     th:src="@{${productForm.imageUrl}}"
                     alt="現行画像プレビュー"
                     class="img-preview" id="imgPreview" />
                <!-- 新規選択後プレビューを JS で表示 -->
                <img th:if="${productForm.imageUrl == null}"
                     src=""
                     alt="プレビュー"
                     class="img-preview"
                     id="imgPreview"
                     style="display:none;" />
                <div th:if="${imageError}" class="error-message" th:text="${imageError}">画像フォーマットが無効です。</div>
            </div>

            <!-- 登録／更新ボタン -->
            <div class="submit-button">
                <button type="submit" th:text="${productForm.id} != null ? '更新する' : '登録する'">登録する</button>
            </div>
        </form>

        <!-- 戻るリンク -->
        <div class="back-link">
            <a th:href="@{/admin/products}">← 商品一覧へ戻る</a>
        </div>
    </div>

    <!-- フッター -->
    <div class="footer">
        © 2025 ○○ Inc.
    </div>
</body>
</html>
